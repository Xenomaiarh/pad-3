name: CI/CD - Services

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

env:
  REGISTRY: ghcr.io

jobs:
  # 1) Detect changes across service folders
  detect_changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      services_changed: ${{ steps.filter.outputs.services }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect paths
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            services:
              - 'services/**'
            server:
              - 'server/**'
            frontend:
              - 'app/**'
            root:
              - 'package.json'

  # 2) Run tests for changed services (if any)
  run_tests:
    name: Run tests for changed services
    runs-on: ubuntu-latest
    needs: detect_changes
    if: always()
    outputs:
      services: ${{ steps.set-services.outputs.services }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Get changed files
        id: changes
        run: |
          # get list of changed files between HEAD and base (works in push and PR)
          if [ "${{ github.event.pull_request.base.sha }}" != "" ]; then
            base=${{ github.event.pull_request.base.sha }}
          else
            base=${{ github.event.before }}
          fi
          echo "base=$base"
          files=$(git diff --name-only $base ${{ github.sha }} || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Compute changed services list
        id: set-services
        run: |
          # get changed files from previous step output
          files="${{ steps.changes.outputs.files }}"
          
          # fallback: use git diff directly if empty
          if [ -z "$files" ]; then
            if [ "${{ github.event.pull_request.base.sha }}" != "" ]; then
              base=${{ github.event.pull_request.base.sha }}
            else
              base=${{ github.event.before }}
            fi
            files=$(git diff --name-only $base ${{ github.sha }} 2>/dev/null || true)
          fi
          
          # extract service names from paths like services/service-name/...
          services=$(echo "$files" | grep '^services/' | cut -d/ -f2 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          # ensure valid JSON array
          if [ -z "$services" ] || [ "$services" = "null" ]; then
            services='[]'
          fi
          
          echo "services=$services" >> $GITHUB_OUTPUT

      - name: Debug - show detected services
        run: |
          echo "Detected services: ${{ steps.set-services.outputs.services }}"

      - name: Run per-service tests
        if: steps.set-services.outputs.services != '[]'
        run: |
          services=${{ steps.set-services.outputs.services }}
          echo "Services changed: $services"
          for svc in $(echo "$services" | jq -r '.[]'); do
            echo "\n==== Testing $svc ===="
            cd services/$svc
            # install deps
            npm ci --no-audit --no-fund
            # generate prisma client if present
            if jq -e '.scripts["prisma:generate"]' package.json > /dev/null 2>&1; then
              npm run prisma:generate || (echo "prisma generate failed for $svc"; exit 1)
            fi
            # run tests if defined
            if jq -e '.scripts.test' package.json > /dev/null 2>&1; then
              echo "Running npm test for $svc"
              npm test || (echo "Tests failed for $svc"; exit 1)
            else
              echo "No test script for $svc â€” running basic lint/smoke checks"
              # basic smoke: check server file exists and is valid JS syntax
              if [ -f src/server.js ]; then
                node -e "require('./src/server.js'); process.exit(0);" || echo "Note: requiring './src/server.js' may start the server; ensure tests exist for CI"
              else
                echo "No src/server.js found for $svc"
              fi
            fi
            cd - >/dev/null
          done

  # 3) Build and push changed service images to GHCR (matrix from services list)
  build_and_push:
    name: Build and push changed images
    runs-on: ubuntu-latest
    needs: run_tests
    if: needs.run_tests.outputs.services != '[]'
    strategy:
      matrix:
        service: ${{ fromJson(needs.run_tests.outputs.services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare image tags (lowercase)
        id: meta
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner=$OWNER" >> $GITHUB_OUTPUT

      - name: Build and push image for service
        uses: docker/build-push-action@v4
        with:
          context: ./services/${{ matrix.service }}
          file: ./services/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.meta.outputs.owner }}/${{ matrix.service }}:${{ github.sha }}
            ghcr.io/${{ steps.meta.outputs.owner }}/${{ matrix.service }}:latest

  # 4) Optional: Deploy to remote via SSH when pushing to main and secrets are set
  deploy:
    name: Deploy to remote server (optional)
    runs-on: ubuntu-latest
    needs: [run_tests, build_and_push]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
      - name: Run remote deploy commands (pull compose from repo and run)
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || '22' }}
          script: |
            set -e
            OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            BRANCH=${{ github.ref_name }}
            REMOTE_DIR=${{ secrets.DEPLOY_REMOTE_DIR || '/opt/eapp' }}
            echo "Logging into GHCR on remote"
            echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u ${OWNER} --password-stdin || true
            mkdir -p ${REMOTE_DIR}
            cd ${REMOTE_DIR}
            echo "Downloading docker-compose from repo"
            curl -fsSL -o docker-compose.yml "https://raw.githubusercontent.com/${{ github.repository }}/${BRANCH}/deploy/docker-compose.deploy.yml"
            if [ -f docker-compose.yml ]; then
              echo "Replacing OWNER placeholder with ${OWNER}"
              sed -i "s/OWNER/${OWNER}/g" docker-compose.yml
            else
              echo "Failed to download docker-compose.deploy.yml"
              exit 1
            fi
            echo "Pulling images and starting stack"
            docker compose pull || true
            docker compose up -d --remove-orphans

  # 5) Ñ‚ÐµÐ»ÐµÐ³Ð°
  notify:
    name: Send Telegram notification
    runs-on: ubuntu-latest
    needs: [detect_changes, run_tests, build_and_push]
    if: always()
    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.detect_changes.result }}" = "failure" ] || [ "${{ needs.run_tests.result }}" = "failure" ] || [ "${{ needs.build_and_push.result }}" = "failure" ]; then
            echo "status=âŒ FAILED" >> $GITHUB_OUTPUT
            echo "color=FF0000" >> $GITHUB_OUTPUT
          else
            echo "status=âœ… SUCCESS" >> $GITHUB_OUTPUT
            echo "color=00FF00" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram message
        continue-on-error: true
        run: |
          curl -X POST \
            -H 'Content-Type: application/json' \
            -d '{
              "chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}",
              "text": "ðŸš€ *CI/CD Pipeline* ${{ steps.status.outputs.status }}\n\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* `${{ github.sha }}`\n*Author:* ${{ github.actor }}\n\n[View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
              "parse_mode": "Markdown"
            }' \
            https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage